#include "w25n04.h"
#include "zf_common_headfile.h"  // ????????

/**
 * @brief ????????
 * 
 * @param state 1?????????0?????§ΰ?
 */
static void w25n04_cs(uint8 state)
{
    gpio_set_level(W25N04_CS_PIN, state);   // ????CS??????
}

/**
 * @brief ???????????W25N04KV?????????????
 * 
 * @param data ?????????
 */
static void w25n04_send_byte(uint8 data)
{
    spi_write_8bit(W25N04_SPI, data);   // ???SPI???????????
}

/**
 * @brief ??W25N04KV???????????????dummy????
 * 
 * @return uint8 ??????????
 */
static uint8 w25n04_receive_byte(void)
{
    return spi_read_8bit(W25N04_SPI);   // ???SPI????????????????0xFF???dummy????
}

/**
 * @brief ?????????????
 * 
 * @param data ???????????????
 * @param len ???????
 */
static void w25n04_send_data(const uint8 *data, uint16 len)
{
    spi_write_8bit_array(W25N04_SPI, data, len);
}

/**
 * @brief ?????????????
 * 
 * @param data ??????????????
 * @param len ?????????????
 */
static void w25n04_receive_data(uint8 *data, uint16 len)
{
    spi_read_8bit_array(W25N04_SPI, data, len);
}

/**
 * @brief ???????????????????????
 * 
 * @param data ?????????
 * @return uint8 ????????????
 */
static uint8 w25n04_transfer_byte(uint8 data)
{
    uint8 rx_data;
    spi_transfer_8bit(W25N04_SPI, &data, &rx_data, 1);
    return rx_data;
}

/**
 * @brief ????16¦Λ?????W25N04KV
 * 
 * @param data ??????16¦Λ????
 */
static void w25n04_send_word(uint16 data)
{
    spi_write_16bit(W25N04_SPI, data);   // ???SPI????16¦Λ????
}

/**
 * @brief ??W25N04KV????16¦Λ????
 * 
 * @return uint16 ???????16¦Λ????
 */
static uint16 w25n04_receive_word(void)
{
    return spi_read_16bit(W25N04_SPI);   // ???SPI????16¦Λ????
}

/**
 * @brief ??????16¦Λ????
 * 
 * @param data ??????16¦Λ?????????
 * @param len 16¦Λ?????????
 */
static void w25n04_send_data_16bit(const uint16 *data, uint16 len)
{
    spi_write_16bit_array(W25N04_SPI, data, len);
}

/**
 * @brief ??????16¦Λ????
 * 
 * @param data ????16¦Λ??????????
 * @param len ??????16¦Λ????????
 */
static void w25n04_receive_data_16bit(uint16 *data, uint16 len)
{
    spi_read_16bit_array(W25N04_SPI, data, len);
}

/**
 * @brief ???W25N04KV??JEDEC ID
 * 
 * @param manufacturer_id ?›¥??????ID?????
 * @param device_id ?›¥?υτID?????
 * @return uint8 0:????1:???
 */
uint8 w25n04_read_id(uint8 *manufacturer_id, uint16 *device_id)
{
    uint8 id_data[3];
    
    // ???§ΰ?
    w25n04_cs(0);
    
    // ??????JEDEC ID???
    w25n04_send_byte(W25N04_CMD_READ_JEDEC_ID);
    w25n04_send_byte(0xFF);
    
    // ???3??????ID????
    id_data[0] = w25n04_receive_byte();  // ??????ID
    id_data[1] = w25n04_receive_byte();  // ?υτID?????
    id_data[2] = w25n04_receive_byte();  // ?υτID?????
    
    // ?????
    w25n04_cs(1);
    
    // ??????????ID?
    *manufacturer_id = id_data[0];
    *device_id = (id_data[1] << 8) | id_data[2];
    
    // ???ID??????
    if (*manufacturer_id == W25N04_MANUFACTURER_ID && 
        *device_id == W25N04_DEVICE_ID) {
        return 1;  // ID??????
    } else {
        return 0;  // ID??????
    }
}

/**
 * @brief ?????W25N04KV????
 * 
 * @return uint8 0:????1:???
 */
uint8 w25n04_init(void)
{
    uint8 ret;
    uint8 manufacturer_id;
    uint16 device_id;
    
    // ?????CS??WP??HOLD????????????????
    gpio_init(W25N04_CS_PIN, GPO, 1, GPO_PUSH_PULL);
    gpio_init(W25N04_WP_PIN, GPO, 1, GPO_PUSH_PULL);
    gpio_init(W25N04_HOLD_PIN, GPO, 1, GPO_PUSH_PULL);
    
    // ?????SPI????????SPI_CS_NULL???CS??????????????
    spi_init(W25N04_SPI, W25N04_SPI_MODE, W25N04_SPI_SPEED, 
             W25N04_SCK_PIN, W25N04_MOSI_PIN, W25N04_MISO_PIN, SPI_CS_NULL);
             
    ret = w25n04_reset(0);
    if(ret == 0)
    {
       zf_log(0, "W25N04KV reset failed!");
    }

    ret = w25n04_disable_write_protection();
    if(ret == 0)
    {
        zf_log(0, "W25N04KV write protection failed!");
    }

    ret = w25n04_read_id(&manufacturer_id, &device_id);
    if(ret == 0)
    {
        zf_log(0, "W25N04KV read id failed!");
    }
    return 1;  // ????????
}

/**
 * @brief ???W25N04KV?????????
 * 
 * @param reg_addr ????????(0xA0/0xB0/0xC0)
 * @return uint8 ????????
 */
uint8 w25n04_read_status(uint8 reg_addr)
{
    uint8 status;
    
    // ???§ΰ?
    w25n04_cs(0);
    
    // ????????????????????????
    w25n04_send_byte(W25N04_CMD_GET_FEATURES);
    w25n04_send_byte(reg_addr);
    
    // ???????????
    status = w25n04_receive_byte();
    
    // ?????
    w25n04_cs(1);
    
    return status;
}

/**
 * @brief ???W25N04KV???
 * 
 * @param timeout_ms ??????(????)??0??????????????
 * @return uint8 0:?????1:???(?υτ???)
 */
uint8 w25n04_wait_busy(uint32 timeout_ms)
{
    uint8 status;
    uint32 start_time = system_getval_ms();  // ?????????
    
    do {
        // ??????????3?????BUSY¦Λ
        status = w25n04_read_status(W25N04_SR3_ADDR);
        
        // ???BUSY=0??????υτ???????????
        if (!(status & W25N04_SR3_BUSY)) {
            return 1;
        }
        
        // ?????????????????????????????
        system_delay_us(10);
        
        // ???????(???timeout_ms=0???????)
        if (timeout_ms > 0 && (system_getval_ms() - start_time) > timeout_ms) {
            return 0;  // ??????????
        }
    } while (1);  // ????????????????
}

/**
 * @brief ????¦ΛW25N04KV§ΰ?
 * 
 * @param reset_mode ??¦Λ????0-???????¦Λ???(0xFF)??1-????¦Λ???+??¦Λ?υτ???(0x66/0x99)
 * @return uint8 0:????1:???
 */
uint8 w25n04_reset(uint8 reset_mode)
{
    // ??????????????
    if (w25n04_wait_busy(100) == 0) {
        return 0;  // ?υτ????????§Ϊ?¦Λ
    }
    
    if (reset_mode == 0) {
        // ???????¦Λ???
        w25n04_cs(0);
        w25n04_send_byte(W25N04_CMD_RESET);
        w25n04_cs(1);
    } else {
        // ????¦Λ???+??¦Λ?υτ???
        w25n04_cs(0);
        w25n04_send_byte(W25N04_CMD_RESET_ENABLE);
        w25n04_cs(1);
        
        // ????υτ?????????¦Λ?υτ???
        
        if(w25n04_wait_busy(10) == 0){
            return 0;
        } 
        
        w25n04_cs(0);
        w25n04_send_byte(W25N04_CMD_RESET_DEVICE);
        w25n04_cs(1);
    }
    
    // ?????¦Λ???????????ο…??¦Λ???????????????????500us
    system_delay_us(500);
    
    // ????υτ???????????100ms
    if (w25n04_wait_busy(100) == 0) {
        return 0;  // ??¦Λ???
    }
    
    return 1;  // ??¦Λ???
}

/**
 * @brief ???W25N04KV??§Υ????
 * 
 * @return uint8 0:????1:???
 */
uint8 w25n04_disable_write_protection(void)
{
    uint8 status;
    
    // ??????????1?????
    status = w25n04_read_status(W25N04_SR1_ADDR);
    
    // ???????§Υ???????¦Λ??WP_E(¦Λ1)??BP0-BP3(¦Λ3-6)
    status &= ~(W25N04_SR1_WP_E | W25N04_SR1_BP0 | W25N04_SR1_BP1 | 
                W25N04_SR1_BP2 | W25N04_SR1_BP3);
    
    // ???§ΰ?
    w25n04_cs(0);
    
    // ????§Υ??????
    w25n04_send_byte(W25N04_CMD_WRITE_ENABLE);
    
    // ?????
    w25n04_cs(1);
    
    // ??????????§Υ?????§Ή
    system_delay_us(10);
    
    // ???§ΰ?
    w25n04_cs(0);
    
    // ???????????????????????1???
    w25n04_send_byte(W25N04_CMD_SET_FEATURES);
    w25n04_send_byte(W25N04_SR1_ADDR);
    
    // ?????????§Υ????¦Λ?????
    w25n04_send_byte(status);
    
    // ?????
    w25n04_cs(1);
    
    // ???§Υ?????
    if (w25n04_wait_busy(100) == 0) {
        return 0;  // ???????????
    }
    
    // ???§Υ????????????
    status = w25n04_read_status(W25N04_SR1_ADDR);
    if (status & (W25N04_SR1_WP_E | W25N04_SR1_BP0 | W25N04_SR1_BP1 | 
                 W25N04_SR1_BP2 | W25N04_SR1_BP3)) {
        return 0;  // §Υ????¦Λ¦Δ????????
    }
    
    return 1;  // ??????§Υ????
}

/**
 * @brief ?????????128KB??
 * 
 * @param block_addr ??????0-4095??
 * @return uint8 0:????1:?????2:§Υ???????3:???????(E_FAIL¦Λ??1)
 */
uint8 w25n04_block_erase(uint16 block_addr)
{
    uint8 status;
    
    // ??????¦¶???
    if (block_addr >= W25N04_BLOCK_COUNT)
    {
        return 0;  // ??§Ή?????
    }
    
    // ???§Υ????????????????????????????????
    // w25n04_disable_write_protection();
    
    // ????§Υ???
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_WRITE_ENABLE);
    w25n04_cs(1);
    
    // ???WEL¦Λ?????¦Λ
    status = w25n04_read_status(W25N04_SR3_ADDR);
    if ((status & W25N04_SR3_WEL) == 0)
    {
        return 2;  // §Υ??????
    }
    
    // ??????????????????64?????
    uint32 page_addr = block_addr * W25N04_PAGES_PER_BLOCK;
    
    // ???????????
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_BLOCK_ERASE_128KB);
    
    // ??????????24¦Λ???????8¦Λ????8¦Λ????8¦Λ??
    // ?????6¦Λ????????????0
    w25n04_send_byte((uint8)(page_addr >> 16));     // ??8¦Λ
    w25n04_send_byte((uint8)(page_addr >> 8));      // ??8¦Λ
    w25n04_send_byte((uint8)(page_addr & 0xC0));    // ??8¦Λ???????6¦Λ?0??
    
    w25n04_cs(1);
    
    // ??????????????????10ms????????
    if (w25n04_wait_busy(W25N04_TIMEOUT_BLOCK_ERASE) == 0)
    {
        return 0;  // ??????
    }
    
    // ???????????
    status = w25n04_read_status(W25N04_SR3_ADDR);
    if (status & W25N04_SR3_E_FAIL)
    {
        // ????????????¦Λ
        uint8 sr3 = status & ~W25N04_SR3_E_FAIL;
        
        // §Υ?????????????
        w25n04_cs(0);
        w25n04_send_byte(W25N04_CMD_SET_FEATURES);
        w25n04_send_byte(W25N04_SR3_ADDR);
        w25n04_send_byte(sr3);
        w25n04_cs(1);
        
        return 3;  // ???????
    }
    
    return 1;  // ???????
}

/**
 * @brief ????????????????????
 * 
 * @param page_addr ????
 * @return uint8 0:???????1:?????ECC????2:???????ECC?????????3:ECC???????????
 */
uint8 w25n04_page_data_read(uint32 page_addr)
{
    uint8 status;
    
    // ??????¦¶???
    if (page_addr >= W25N04_TOTAL_PAGES)
    {
        return 0;  // ??§Ή??????
    }
    
    // ???????????????
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_PAGE_DATA_READ);
    
    // ??????????24¦Λ?????
    w25n04_send_byte((uint8)(page_addr >> 16));     // ??8¦Λ
    w25n04_send_byte((uint8)(page_addr >> 8));      // ??8¦Λ
    w25n04_send_byte((uint8)(page_addr));           // ??8¦Λ
    
    w25n04_cs(1);
    
    // ?????????
    if (w25n04_wait_busy(W25N04_TIMEOUT_PAGE_READ) == 0)
    {
        return 0;  // ??????
    }
    
    // ??????????3???ECC??
    status = w25n04_read_status(W25N04_SR3_ADDR);
    
    // ???ECCS[1:0]¦Λ
    uint8 ecc_status = (status >> 4) & 0x03;
    
    switch (ecc_status)
    {
        case 0:  // 00 - ???ECC????
            return 1;
        case 1:  // 01 - 1¦ΛECC?????????
            return 2;
        case 2:  // 10 - 2¦ΛECC?????????????????
            return 2;
        case 3:  // 11 - ?????????ECC????
            return 3;
        default:
            return 0;  // ????????????
    }
}

/**
 * @brief ??????????????
 * 
 * @param column_addr ?§Φ??(0-2111)
 * @param data ????????›¥¦Λ??
 * @param len ?????????????
 * @return uint8 0:????1:???
 */
uint8 w25n04_read_data(uint16 column_addr, uint8 *data, uint16 len)
{
    // ?§Φ????¦¶???
    if (column_addr >= W25N04_PAGE_SIZE)
    {
        return 0;  // ??§Ή???§Φ??
    }
    
    // ??????????????????????
    if (column_addr + len > W25N04_PAGE_SIZE)
    {
        len = W25N04_PAGE_SIZE - column_addr;
    }
    
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_READ_DATA);
    w25n04_send_byte((uint8)(column_addr >> 8));
    w25n04_send_byte((uint8)(column_addr));
    w25n04_send_byte(0xFF);  // ?????
    
    // ???16¦Λ????
    if (len >= 2)
    {
        uint16 word_count = len / 2;
        uint16 *word_data = (uint16 *)data;
        
        // ???16¦Λ????
        for (uint16 i = 0; i < word_count; i++)
        {
            word_data[i] = w25n04_receive_word();
        }
        
        // ????????????
        if (len % 2)
        {
            data[len - 1] = w25n04_receive_byte();
        }
    }
    else
    {
        // ????????????????8¦Λ????
        for (uint16 i = 0; i < len; i++)
        {
            data[i] = w25n04_receive_byte();
        }
    }
    
    w25n04_cs(1);
    return 1;
}

/**
 * @brief ?????????????
 * 
 * @param page_addr ????
 * @param column_addr ?§Φ??
 * @param data ????????›¥¦Λ??
 * @param len ?????????????
 * @return uint8 0:????1:?????ECC????2:???????ECC??????????3:ECC???????????
 */
uint8 w25n04_read_page(uint32 page_addr, uint16 column_addr, uint8 *data, uint16 len)
{
    uint8 result;
    
    // ??????¦¶???
    if (page_addr >= W25N04_TOTAL_PAGES)
    {
        return 0;  // ??§Ή??????
    }
    
    // ?§Φ????¦¶???
    if (column_addr >= W25N04_PAGE_SIZE)
    {
        return 0;  // ??§Ή???§Φ??
    }
    
    // ??????????????????????
    if (column_addr + len > W25N04_PAGE_SIZE)
    {
        len = W25N04_PAGE_SIZE - column_addr;  // ?????????????????
    }
    
    // ??1??????????????????§ΰ??????????
    result = w25n04_page_data_read(page_addr);
    
    // ????????????§Σ????????ECC????????????
    if (result == 0 || result == 3)
    {
        return result;
    }
    
    // ??2??????????????????
    if (w25n04_read_data(column_addr, data, len) == 0)
    {
        return 0;  // ?????????????????
    }
    
    // ??????????????1=?????2=?§α??????ECC????
    return result;
}

/**
 * @brief ???????????????????
 * 
 * @param column_addr ?§Φ??(0-2111)
 * @param data ??????????
 * @param len ???????
 * @return uint8 0:????1:???
 */
uint8 w25n04_program_data_load(uint16 column_addr, uint8 *data, uint16 len)
{
    if (column_addr >= W25N04_PAGE_SIZE)
    {
        return 0;
    }
    
    if (column_addr + len > W25N04_PAGE_SIZE)
    {
        len = W25N04_PAGE_SIZE - column_addr;
    }
    
    if (!w25n04_write_enable())
    {
        return 0;
    }
    
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_LOAD_PROGRAM_DATA);
    w25n04_send_byte((uint8)(column_addr >> 8));
    w25n04_send_byte((uint8)(column_addr));
    
    // ???16¦Λ????
    if (len >= 2)
    {
        uint16 word_count = len / 2;
        uint16 *word_data = (uint16 *)data;
        
        // ????16¦Λ????
        for (uint16 i = 0; i < word_count; i++)
        {
            w25n04_send_word(word_data[i]);
        }
        
        // ????????????
        if (len % 2)
        {
            w25n04_send_byte(data[len - 1]);
        }
    }
    else
    {
        // ????????????????8¦Λ????
        for (uint16 i = 0; i < len; i++)
        {
            w25n04_send_byte(data[i]);
        }
    }
    
    w25n04_cs(1);
    return 1;
}

/**
 * @brief ??§??????????????????????§Υ??????
 * 
 * @param page_addr ?§Υ???????
 * @return uint8 0:????1:?????2:??????(P_FAIL¦Λ??1)
 */
uint8 w25n04_program_execute(uint32 page_addr)
{
    // ??????¦¶???
    if (page_addr >= W25N04_TOTAL_PAGES)
    {
        return 0;  // ??§Ή??????
    }
    
    // §Υ???
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_WRITE_ENABLE);
    w25n04_cs(1);
    
    // ???§Υ????????
    uint8 status = w25n04_read_status(W25N04_SR3_ADDR);
    if ((status & W25N04_SR3_WEL) == 0)
    {
        return 0;  // §Υ??????
    }
    
    // ?????????????
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_PROGRAM_EXECUTE);
    
    // ??????????24¦Λ?????
    w25n04_send_byte((uint8)(page_addr >> 16));  // ??8¦Λ
    w25n04_send_byte((uint8)(page_addr >> 8));   // ??8¦Λ
    w25n04_send_byte((uint8)(page_addr));        // ??8¦Λ
    
    w25n04_cs(1);
    
    // ?????????
    if (w25n04_wait_busy(W25N04_TIMEOUT_PAGE_PROG) == 0)
    {
        return 0;  // ??????
    }
    
    // ??????????
    status = w25n04_read_status(W25N04_SR3_ADDR);
    if (status & W25N04_SR3_P_FAIL)
    {
        // ???????????¦Λ
        uint8 sr3 = status & ~W25N04_SR3_P_FAIL;
        
        // §Υ?????????????
        w25n04_cs(0);
        w25n04_send_byte(W25N04_CMD_SET_FEATURES);
        w25n04_send_byte(W25N04_SR3_ADDR);
        w25n04_send_byte(sr3);
        w25n04_cs(1);
        
        return 2;  // ??????
    }
    
    return 1;  // ?????
}

/**
 * @brief §Υ???????????
 * 
 * @param page_addr ????
 * @param column_addr ?§Φ??
 * @param data ?§Υ????????????
 * @param len ???????
 * @return uint8 0:????1:?????2:??????????
 */
uint8 w25n04_write_page(uint32 page_addr, uint16 column_addr, uint8 *data, uint16 len)
{
    uint8 result;
    
    // ??????¦¶???
    if (page_addr >= W25N04_TOTAL_PAGES)
    {
        return 0;  // ??§Ή??????
    }
    
    // ?§Φ????¦¶???
    if (column_addr >= W25N04_PAGE_SIZE)
    {
        return 0;  // ??§Ή???§Φ??
    }
    
    // ???????§Υ?????????????
    if (column_addr + len > W25N04_PAGE_SIZE)
    {
        len = W25N04_PAGE_SIZE - column_addr;  // ?????????????????
    }
    
    // ??1??????????????§ΰ??????????
    if (w25n04_program_data_load(column_addr, data, len) == 0)
    {
        return 0;  // ??????????
    }
    
    // ??2??????§?????????????????§Υ??Flash
    result = w25n04_program_execute(page_addr);
    
    return result;  // ????????
}

/**
 * @brief ??????????????????????(???????????)
 * 
 * @param column_addr ?§Φ??(0-2111)
 * @param data ??????????
 * @param len ???????
 * @return uint8 0:????1:???
 */
uint8 w25n04_random_program_data_load(uint16 column_addr, uint8 *data, uint16 len)
{
    // ?§Φ????¦¶???
    if (column_addr >= W25N04_PAGE_SIZE)
    {
        return 0;  // ??§Ή???§Φ??
    }
    
    // ??????????????????????
    if (column_addr + len > W25N04_PAGE_SIZE)
    {
        len = W25N04_PAGE_SIZE - column_addr;  // ?????????????????
    }
    
    // §Υ???
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_WRITE_ENABLE);
    w25n04_cs(1);
    
    // ???§Υ????????
    uint8 status = w25n04_read_status(W25N04_SR3_ADDR);
    if ((status & W25N04_SR3_WEL) == 0)
    {
        return 0;  // §Υ??????
    }
    
    // ??????????????????(???????????)
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_LOAD_RANDOM_PROGRAM_DATA);
    
    // ?????§Φ????16¦Λ?????
    w25n04_send_byte((uint8)(column_addr >> 8));  // ??8¦Λ
    w25n04_send_byte((uint8)(column_addr));       // ??8¦Λ
    
    // ????????????
    for (uint16 i = 0; i < len; i++)
    {
        w25n04_send_byte(data[i]);
    }
    
    w25n04_cs(1);
    
    return 1;  // ?????????
}

/**
 * @brief §Υ???
 * 
 * @return uint8 0:????1:???
 */
uint8 w25n04_write_enable(void)
{
    // §Υ???
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_WRITE_ENABLE);
    w25n04_cs(1);
    
    // ???§Υ????????
    uint8 status = w25n04_read_status(W25N04_SR3_ADDR);
    if ((status & W25N04_SR3_WEL) == 0)
    {
        return 0;  // §Υ??????
    }
    
    return 1;  // §Υ?????
}

/**
 * @brief ???W25N04KV??ECC????
 * 
 * @return uint8 0:????1:???
 */
uint8 w25n04_disable_ecc(void)
{
    uint8 status;
    
    // ??????????2?????
    status = w25n04_read_status(W25N04_SR2_ADDR);
    
    // ???ECC???¦Λ(ECC_E????4¦Λ)
    status &= ~W25N04_SR2_ECC_E;
    
    // §Υ???
    w25n04_cs(0);
    w25n04_send_byte(W25N04_CMD_WRITE_ENABLE);
    w25n04_cs(1);
    
    // ??????????§Υ?????§Ή
    system_delay_us(10);
    
    // ???§ΰ?
    w25n04_cs(0);
    
    // ???????????????????????2???
    w25n04_send_byte(W25N04_CMD_SET_FEATURES);
    w25n04_send_byte(W25N04_SR2_ADDR);
    
    // ?????????ECC???¦Λ?????
    w25n04_send_byte(status);
    
    // ?????
    w25n04_cs(1);
    
    // ???§Υ?????
    if (w25n04_wait_busy(100) == 0) {
        return 0;  // ???????????
    }
    
    // ???ECC????????
    status = w25n04_read_status(W25N04_SR2_ADDR);
    if (status & W25N04_SR2_ECC_E) {
        return 0;  // ECC???¦Λ¦Δ????????
    }
    
    return 1;  // ??????ECC
}
